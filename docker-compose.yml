# TCG Tracker - Docker Compose
#
# Production (pull from GHCR):
#   IMAGE_TAG=<commit-sha> docker compose up -d
#
# Local development (build locally):
#   docker compose -f docker-compose.yml -f docker-compose.local.yml up
#
# Data is preserved via bind mounts:
#   - Database: ./data/tcg_tracker.db
#   - Pokemon data: ./data/pokemon-tcg-data/

services:
  # Go Backend API (serves frontend static files)
  backend:
    image: ghcr.io/codyseavey/tcg-tracker/app:${IMAGE_TAG:-latest}
    container_name: tcg-backend
    ports:
      - "3080:8080"
    environment:
      - PORT=8080
      - DB_PATH=/app/data/tcg_tracker.db
      - POKEMON_DATA_DIR=/app/data/pokemon-tcg-data
      - FRONTEND_DIST_PATH=/app/frontend/dist
      - GIN_MODE=release
      - IDENTIFIER_SERVICE_URL=http://identifier:8099
      - JUSTTCG_API_KEY=${JUSTTCG_API_KEY:-}
      - JUSTTCG_DAILY_LIMIT=${JUSTTCG_DAILY_LIMIT:-1000}
      - ADMIN_KEY=${ADMIN_KEY:-}
      - SYNC_TCGPLAYER_IDS_ON_STARTUP=${SYNC_TCGPLAYER_IDS_ON_STARTUP:-true}
      # Google Cloud Translation API (for Japanese card support)
      # Set GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/gcloud.json if credentials file is mounted
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-}
      # Gemini API for Japanese card identification (preferred over Google Translate)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - TRANSLATION_CONFIDENCE_THRESHOLD=${TRANSLATION_CONFIDENCE_THRESHOLD:-800}
    depends_on:
      - identifier
    volumes:
      - ./data:/app/data
    restart: always

  # Identifier service (Python OCR) - optional, for server-side OCR
  identifier:
    image: ghcr.io/codyseavey/tcg-tracker/identifier:${IMAGE_TAG:-latest}
    container_name: tcg-identifier
    # Port 8099 exposed only within Docker network (backend calls it)
    expose:
      - "8099"
    environment:
      - HOST=0.0.0.0
      - PORT=8099
      - USE_GPU=0
      # Japanese+English (ja,en) requires GPU; use English-only for CPU mode
      - OCR_LANGUAGES=${OCR_LANGUAGES:-en}
    restart: always
